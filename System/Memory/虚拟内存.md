直接为进程分配物理内存的缺点如下:
1. 地址空间不隔离, 容易招致漏洞或恶意程序攻击, 造成整个系统崩溃.
2. 内存使用效率低, 空间不够时, 需要将整个程序换入换出.
3. 程序运行地址不确定. 导致程序编写 (数据与指令跳转) 复杂.

引入虚拟内存地址技术, 即每个进程的虚拟地址空间都是隔离的完整的 (32 位下为 4GB), 由操作系统的 MMU (Memory Management Unit) 负责离散分配物理内存空间, 将虚拟地址转化为物理地址. 技术上, 装入时, 程序部分装入; 运行时, 数据换入换出, 按需调页; 当物理内存不足时, 不需要的换出.

```
CPU -- virtual_addr --> MMU -- pysical_addr --> Memory
```

## 虚拟页式存储

 [分页技术](分页技术.md)是最常用的虚拟内存技术. 有如下特点:
- 按需调页, Demand Paging
- 页面置换, Swapping: 将暂时不同的页面换出内存
- 页框分配: 为各个合理分配页框数量
- 访问控制, Access Control.

### 按需调页

为页表增加: 有效无效位, 其中无效位有*相关页无效, 页面有效但不在内存中*两种情况. 当试图访问无效页表项时, 会产生**缺页中断, Page Fault Trap**.

![|450](../../attach/Pasted%20image%2020230621083243.png)

为了支持按需调页, 通常在外存划分**交换区**, 交换区文件连续分配, 以支持更快读写. 其他区域称为文件区, 离散分配, 利用率高.

### 页面置换

按需调页选中的外存页调入内存时, 若内存无空闲页框, 则按**页面淘汰算法**换出一个页, 然后调入选中页. 为了减少交换负担, 还用*脏位 dirty bit* 记录页面是否被修改, 若未被修改, 则直接丢弃.

![|400](../../attach/Pasted%20image%2020230621091127.png)

常见页面交换算法:
- FIFO
- OPT, 最优
- LRU, 最近最少使用 (linux 使用)
- CLOCK, 时钟置换算法, 二次机会

### 页框分配

**抖动, 颠簸, thrashing**: 一个进程页面的频繁换入换出. 产生抖动的诱因是驻留集过小, 即驻留集远小于局部 (程序最近访问页面集合). 解决办法也就是使驻留集约等于局部, 当物理内存严重不足时, 虚拟内存提供的扩存作用有限.

### 访问控制

MMU 需要控制系统或程序对内存的访问, 比如说:
1. 防止程序访问脏数据.
2. 防止可执行程序内存段被写入.
3. 防止可写入内存段被执行.

| flag          |                                                        |
| ------------- | ------------------------------------------------------ |
| `V`           | 此 PTE 有效                                            |
| `FOE`         | Fault on Execute, 尝试执行该页面时, 处理器执行缺页中断 |
| `FOW`         | Fault on Write, 尝试写入该页面时, 处理器执行缺页中断   |
| `FOR`         | Fault on Read                                          |
| `ASM`         | Address Space Match.                                   |
| `KRE`, `KWE`  | 内核态程序可以读/写该页面.                             |
| `URE`, `UWE`  | 用户态程序可以读/写该页面.                             |
| `GH`          |                                                        |
| `_PAGE_DIRTY` |                                                        |
| `_PAGE_ACCESSED`              |                                                        |
