管道 (pipe)

分类:
1. pipe, 普通管道. 单工, 单向传输, 或仅在进程组内使用.
2. s_pipe, 流管道. 半双工, 仅在进程组内使用, 双向传输.
3. name_pipe, 具名管道

![|300](../../attach/Pasted%20image%2020230619201928.png)

## 普通管道

管道借助文件系统实现, 原理见 `fs/pipe.c`. 

借助 fork 实现两进程连接, 读进程关闭写端, 写进程关闭读端, 从而单向传输.

```c
    int n;
    int fd[2];
    pid_t pid;
    char line[MAXLINE];

    if(pipe(fd)  0){                 /* 先建立管道得到一对文件描述符 */
        exit(0);
    }

    if((pid = fork())  0)            /* 父进程把文件描述符复制给子进程 */
        exit(1);
    else if(pid > 0){                /* 父进程写 */
        close(fd[0]);                /* 关闭读描述符 */
        write(fd[1], "\nhello world\n", 14);
    }
    else{                            /* 子进程读 */
        close(fd[1]);                /* 关闭写端 */
        n = read(fd[0], line, MAXLINE);
        write(STDOUT_FILENO, line, n);
    }

    exit(0);
```

## 命名管道

named PIPE, 也叫 FIFO (First In, First Out). 是由内核管理的一种特殊文件, 可以用`文件路径`让无关的两进程建立连接.

```c
#include <sys/types.h>
#include <sys/stat.h>

int mkfifo(const char *filename, mode_t mode);
int mknode(const char *filename, mode_t mode | S_IFIFO, (dev_t) 0 );
```

实例:
```c
#include <stdio.h>  
#include <stdlib.h>  
#include <sys/types.h>  
#include <sys/stat.h>  

int main()  
{  
    int res = mkfifo("/tmp/my_fifo", 0777);  
    if (res == 0)  
    {  
        printf("FIFO created/n");  
    }  
     exit(EXIT_SUCCESS);  
}
```