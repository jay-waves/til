> https://blog.csdn.net/hguisu/article/details/7401963

linux 支持很多文件系统:
- 磁盘文件系统: 如 ext, xfs, 将数据存储于磁盘.
- 内存文件系统: 存储与内存, 常用于共享内核数据, 如 `/proc`, `/sys`
- 网络文件系统: 如 nfs, smb

| FS              | 描述                                                                     |
| --------------- | ------------------------------------------------------------------------ |
| MINIX           | linux 第一代操作系统, 性能欠佳. 文件名最大 `14char`, 文件体积最大 `64MB` |
| Ext - [Ext4](ext4.md)      | extended file system. linux 原生文件系统                                 |
| swap            | linux 用于交换分区 (类似 windows 的虚拟内存) 的 VFS                      |
| NFS             | Network File System, 用于实现主机间文件挂载共享                          |
| iso9660         | 光盘标准文件系统                                                         |
| [FAT](fat.md)   | windows 下文件系统. vFAT 也叫 FAT32.                                     |
| NTFS            | windows NT 文件系统, 更安全高效, linux 默认无法识别                      |
| [proc](proc.md) | linux 用于记录系统调试信息的 VFS, 基于内存                               |
| ufs             | Sun 公司的 Solaris, SunOS 操作系统所用文件系统                           |
| sysfs           | linux 用于管理内存存储的 VFS, 基于内存                                   |
| tmpfs           | linux 用于管理临时文件的 VFS, 基于内存. 可用 swap 替代.                  |
| shm             | linux 用于共享内存的 VFS                                                 |
| msdos           |                                                                          |
| smb             |                                                                          |
| sysv            |                                                                          |
| exFAT           | Extedned File Allocation Table, 适用于 SSD.                                                                         |

linux 每个文件有两个结构:
- 索引节点 index node, `inode`, 记录文件元信息, **是文件的唯一标识**. 会占用磁盘空间. 目录也是一种文件, 用于保存子目录和文件信息.
- 目录项 directory enty, `dentry`, 记录文件名, 索引节点指针以及层级关系(目录结构). 内核将已读取的目录/文件索引缓存在内存中, 称为目录项.

索引节点可以被多个目录项引用, 即一个文件实体可以有多个别名. 如硬链接.

磁盘格式化时, 会划分为三个存储区域, 分别为:
- **超级块**, 存储文件系统信息, 如块数和空闲数. 挂载文件系统时被载入内存.
- 索引节点区, 存储索引节点. 当文件被访问时载入内存.
- 数据块区, 存储文件数据.

用户一般以字节为单位处理文件数据, 而操作系统以数据块为单位处理. 文件系统负责屏蔽这种差异.

## 空闲空间管理

保存新数据块时, 需要在磁盘上挑选一个未被使用的数据块. 

*空闲表法*, 用一张表存储磁盘中空闲区域. 当有大量碎片化空闲区时, 空闲表体积大, 效率低. 与显式表对应的, 还有*隐式链表法*, 即每个块都存储一个链表头, 将空闲块链接为一个链表. 空闲链表不支持随机访问, 也不适合大型文件系统.

```c
struct {
	int start; /* 空闲区域起始块号 */
	int len;   /* 空闲区域长度 */
} free_table[];
```


*位图法*, 利用二进制的一位来标识磁盘中一个块的使用情况, 0 标识盘块空闲. linux 使用该方法对 inode 空闲块与磁盘空闲块进行管理[^1].

```c
11111001111111100100101101101011000...
```

[^1]:  见 [linux bitmap](../../Data%20Structure/linux%20kernel/bitmap.md)接 I/O**, 指是否利用操作系统的页缓存. 当不指定 `O_DIRECT` 标志时, 默认非直接 I/O, 读写操作和内核缓存交互, 由内核决定何时与磁盘交互.

**缓冲 I/O**, 指是否利用标准库缓冲. 利用标准库缓冲时, 程序遇到换行时才输出, 避免频繁系统调用.

I/O 分为两个过程:
1. 数据准备, 此时内核中数据尚未准备好.
2. 数据从内核空间拷贝到用户进程缓冲区.

|              | 数据准备                                    | 数据拷贝          | 系统调用              |
| ------------ | ------------------------------------------- | ----------------- | --------------------- |
| 阻塞 I/O     | `read()` 阻塞等待, 直到数据拷贝结束才返回   | `read()` 阻塞等待 | `read`                |
| 非阻塞 I/O   | `read()` 阻塞轮询, 立即返回, 但持续轮询     | `read()` 阻塞等待 | `read, poll`          |
| I/O 多路复用 | `select()` 阻塞等待, 释放 CPU, 直到事件通知 | `read()` 阻塞等待 | `select, epoll, read` |
| 非同步 I/O   | `aio_read()` 立即返回                       | 内核自动完成数据拷贝, 事件通知                  | `aio_read`            |

统称阻塞 I/O, 非阻塞 I/O, 基于非阻塞 I/O 的多路复用为**同步 I/O**. 它们在数据拷贝阶段都是要等待的, 也就是同步的.