## 传输层特点

只有在网络边缘才有传输层, 传输层功能有:
- 提供**主机进程**间端到端通讯, 而网络层仅仅是主机间通信.
- 对报文数据部分进行差错检测, 而IP报文校验和仅检查首部.

**复用和分用**: 运输层涉及不同进程 (应用层) 进行协议复用, 仅用 IP 来标识收发者是不够的, 需要引入端口号来标识同一 IP 地址的不同进程. 16 位端口号分为三类:
- 系统端口: 0-1023, 用于熟知的协议和进程
- 用户端口: 1024-49151, 用于一般服务进程
- 动态端口: 也称短暂端口, 49152-65535, 用于一般客户进程.

> 标识进程不适用 PID, 而使用端口号, 是为了规避不同操作系统的规范差别.

传输层协议主要分为:
- 面向无连接的 [UDP](UDP.md)
- 面向连接的 [TCP](TCP.md)

|          | UDP        | TCP                  |
| -------- | ---------- | -------------------- |
| 是否连接 | 无连接     | 面向连接             |
| 是否可靠 | 不可靠 (尽最大努力交付)     | 可靠(流量和拥塞控制) |
| 连接对象 | 支持多对多 | 只能一对一           |
| 传输方式 | 面向报文   | 面向字节流           |
| 首部开销 | 8字节      | 至少20字节, 至多60字节                     |

### QOS

QoS (Quality of Service) 除了常见[网络性能指标](../网络体系结构.md)外, 还强调可靠性:
- 消息持久化
- 死信队列
- 消息投递保证 (Delivery guarantee)
	- At Most Once: 可能丢失或重复
	- At Least Once: 可能重复, 不丢失
	- Execatly Once: 既不重复, 也不丢失.

## 消息模式

|                   | 模型                             | 应用         | 常见拓扑 |
| ----------------- | -------------------------------- | ------------ | ---- |
| BUS               | 多对多广播 | Gossip |  Mesh [^1]    |
| PAIR              | 一对一通信                       | P2P          |      |
| Publish/Subscirbe | PUB 广播, SUB 订阅过滤           | MQTT         | Broker     |
| Request/Reply     | REQ 请求, REP 应答, 严格对应     | RPC          |      |
| Push/Pull         | PUSH 分发给 PULL, 按某种调度方式 | 负载均衡     |      |

[^1]: Mesh 指去中心化的网络拓扑, Broker 则指有中心的星型拓扑. 有例外, 比如 DDS 的消息模式是 PUB/SUB, 但是使用 Mesh 的分布式网络拓扑.