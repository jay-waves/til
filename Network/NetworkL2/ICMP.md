## ICMP

ICMP, Internet Control Message Protocol, 报文控制协议. 分为查询报文和差错报文两类.

```
+-----------+-----------+-----------+---------------+-----------+
| IP Header | ICMP Type | ICMP Code | ICMP CheckSum | ICMP Data |
+-----------+-----------+-----------+---------------+-----------+
```

### 查询报文

`ping` 工具基于 ICMP 查询报文,
- 查询请求报文称为 `ICMP ECHO REQUEST`, 代码为 `8`
- 查询回复报文为 `ICMP ECHO REPLY`, 代码为 `0`. 
- 查询报文有序号, 通常一次发送 10 组, 并且计算往返时间 RTT.

### 差错报文

差错报文可能报告不同类型的错误:
- 终点不可达, 代码为 `3`, 分为: 
	- 网络不可达.
	- 主机不可达.
	- 协议不可达.
	- 端口不可达.
	- 需要分片 (MTU 不够), 但是报文设置了不分片.
- 源点抑制 (Source Quench), 代码为 `4`. 当网络发生拥塞时, 终点会发出源点抑制响应, 要求降低发送速率. 
	由于可能引入额外开销或滥用, 现代网络不使用该法, 而是用 TCP 自带的流量控制机制.
- 时间超时, 代码为 `11`
- 路由重定向, 代码为 `5`. 当网关发现有更优路由路径, 会向主机发送 ICMP 重定向报文, 让其向另一个更优网关发送流量. 由于 ICMP 重定向安全问题, 一般被禁用.

`traceroute` 利用了 *ICMP 差错报文*来追踪整条路由路径:
1. 发送 `TTL=1` 的 UDP 报文, 
2. 第一个路由器接收报文, 就返回 *ICMP 时间超时差错报文*, 报告时间超时, 本机就知道了第一跳路由的 IP 信息. 
3. 后续 `traceroute` 会不断增加 `TTL` 值, 直到获得整个路由路径. 

对于目的主机, `traceroute` 会设置 UDP 报文的端口为不可能的值 (>30000), 此时目的主机会返回 *ICMP 端口不可达差错报文*.