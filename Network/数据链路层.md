## 数据链路层

数据链路层三大问题:
- 封装成帧 (frame)
- 透明传输: 帧封装不会对数据内容产生限制或干预. 如不限制长度 (实际上限制), 不关心完整性.
- 差错检测: 错误检测, 纠错, 和重传等一定程度的可靠性.

**透明传输问题和差错检测问题是否矛盾?** #FAQ 

是的, 要实现差错检测, 就必定不是透明传输. 这体现了数据链路层对不同场景下不同通信需求的平衡. 透明传输, 即数据链路层不会对上下层交互的数据内容进行修改和干预, 对于上下层而言是透明的. 当传输层检测到错误时, 一些电话协议可以要求重传, 此时对于物理层不是透明的; 以太网协议则规定直接丢弃帧, 此时传输层会检测到并处理报文缺失异常, 因而对传输层不是透明的. 

当错误检测较严格时, 可以确保数据的完整性, 但是不符合透明传输的要求, 直接后果是传输延迟比较大. 当错误检测不严格时, 更符号透明纯属的要求, 适合实时性较强的应用.

### 帧定界

SOH, start of header, `0x01`; EOT, end of transimission, `0x04`. 是 ACSII 码中规定的通信专用字符.

帧的数据载荷长度上限, Maximum Transfer Unit, MTU. 以太网 `MTU= 1500 bytes`

### 透明传输

数据中二进制码恰好和 `SOH`, `EOT` 重复, 就会误解帧的边界. 解决办法是**字节填充**.

当数据中出现通信专用字符时, 在进入数据链路层时, 在通信字符前插入 `ESC=0x1B` 转义字符; 在离开数据链路层时, 删除插入的 `ESC`.

例子:  

```
原始数据:

(SOH) EOT SOH ESC (EOT)

数据链路层数据:

SOH  ESC EOT  ESC SOH  ESC ESC  EOT
```

### 差错检测

错误检测机制, FCS, Frame Check Sequence. 常用方法有**奇偶校验, 汉明码, 循环冗余校验**, 传输层还使用反码求和校验. FCS 附加在数据帧尾部.

## 协议

| 名称                   | 标准        | 报文 |
| ---------------------- | ----------- | ---- |
| 以太网, Ethernet       | IEEE 802.3  | MAC  |
| 无线局域网, Wi-Fi      | IEEE 802.11 | MAC  |
| 点对点协议, PPP        | RFC 1661    | HDLC |
| 高清晰度链路控制, HDLC | ISO 13239   | HDLC |
| RLC/MAC                | 3GPP UMTS (3G)   |  MAC    |
| RLC/MAC/PDCP           | 3GPP LTE (4G)   |  MAC    |
| RLC/MAC/PDCP/SDAP      | 3GPP NR (5G)           | MAC     |

## MAC 帧

交换机的 MAC 地址学习过程:
- 每接收到一个数据帧, 首先读取帧的源 MAC 地址和进入的端口, 并记录在 MAC 地址表中. 
- MAC 地址表应不断更新, 并设有老化时间.

报文在数据链路层转发过程:
1. 决定下一跳 IP 地址
	- 如果在同一子网下 (网段和掩码相同), 下一跳 IP 地址直接设为目的地址.
	- 如果不在同一子网下, 下一跳 IP 地址设置为默认网关 (一般是路由器).
2. 通过 ARP 协议获取同一网段下下一跳 IP 地址对应的 MAC 地址.
3. 前往下一跳过程中途径各层交换机, 交换机查询 MAC 地址表
	- 如果有匹配表项, 转发给对应的交换机端口.
	- 如果没有匹配表项, 会泛洪该数据帧, 将其转发给所有端口.
	- 转发过程需要修改 MAC 帧头部:
		- 将源 MAC 地址改为当前交换机 MAC 地址.
		- 重新计算并修改帧校验和 (FCS)
4. 如果是跨子网发送, 数据包转发至默认网关, 网关通过路由协议决定下一跳 IP 地址.

> 没有代理的情况下, 出站报文的目的 IP 地址在传输过程中不变, 目的 MAC 地址和源 MAC 地址可能不断改变.

```
  0   1   2   3   4   5   6   7   0   1   2   3   4   5   6   7
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|                          Frame Control                        |
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|                          Duration/ID                          |
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|                                                               |
|                     Address 1 (Receiver) 48b                  |
|                                                               |
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|                                                               |
|                  Address 2 (Transmitter) 48b                  |
|                                                               |
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|                                                               |
|                    Address 3 (Filtering) 48b                  |
|                                                               |
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|                          Sequence Control                     |
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|                          Frame Body (data...)                 |
                            .....
|                                                               |
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
|                                                               |
|                   Frame Check Sequence 32b                    |
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
```

