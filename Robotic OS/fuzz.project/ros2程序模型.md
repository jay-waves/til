![|500](../../attach/Pasted%20image%2020240323154317.png)

在 ROS 2的体系结构中，节点（Node）是最基本的执行单位，负责特定功能的实现，如数据处理或硬件接口。每个节点可以包含多种通信机制，包括订阅者（Topic Subscribers）、定时器（Timer）、服务服务器（Service Servers）和服务客户端（Service Clients）。这些通信实体的目的是为了接收和发送数据，以及提供不同的服务。

节点注册到执行器（Executor）中，执行器是一个控制实体，负责协调节点的活动。当节点的一个通信事件发生时，比如收到一个主题消息或服务请求，执行器会调用相应的处理函数，或称为回调函数（Callback）。这些回调函数是预先定义的，用来响应特定类型的事件，如`topic_receive()`用于处理主题消息，`request_receive()`用于处理服务请求。

在节点的生命周期中，可以使用生命周期状态机（Lifecycle SM）来管理节点的状态，这在管理复杂节点时特别有用。生命周期状态机允许节点在不同状态之间转换，如激活（activate）、去激活（deactivate）和清理（cleanup）。每个状态变化都可以有对应的回调函数，例如`on_activate()`在节点激活时调用，`on_cleanup()`在节点清理资源时调用。

执行器通过反复调用`spin()`函数来持续检查和处理事件。`spin()`函数是一个事件循环，保持节点持续运行并相应事件。当`spin()`被调用时，执行器会检查是否有待处理的事件，如新的消息或服务请求，并且调用相应的回调函数来处理这些事件。

在执行器内部，`execute_any_*()`函数是实现细节的一部分，这个函数根据事件的类型和优先级选择一个事件来处理。处理过程包括执行注册的回调函数，这些函数是在节点初始化时注册的，如`registe_handler()`用于注册定时器事件的回调。

总体而言，ROS2的程序机制基于事件驱动的模型，通过节点、执行器和回调函数协同工作来
响应和处理各种事件，这些事件可能来源于数据的接收、定时器的触发、服务的请求和响应，
以及节点生命周期状态的变化。通过这种灵活且模块化的设计，ROS 2能够支持复杂且多样化
的机器人系统开发。

> executor本身是没有状态的，所以直到节点句柄释放之前，它一直在`spin()`，此时收到外部信息
> 还是可能执行回调函数。如果此时已经到了句柄释放阶段，其释放顺序错误可能导致关闭期间的UAF等数据竞争错误。
> 各个callback可能共享内存，所以可能发生常规并发bugs

在ROS 2中，关闭过程或节点的有序停止通常涉及节点生命周期管理，它确保所有资源被适当地释放，并且所有正在进行的活动被优雅地终止。生命周期状态机（Lifecycle SM）在这个过程中扮演了中心角色。

当节点即将关闭时，首先会执行生命周期状态机中的`on_activate()`回调，如果它在当前状态下是活跃的。`on_activate()`回调的执行是节点从非活动状态变为活跃状态的信号，它允许节点开始执行它的主要功能，如接收和处理数据。然而，在关闭过程中，`on_activate()`的调用通常是为了让节点完成必要的最后操作，例如完成正在处理的数据传输或请求。

紧接着，节点将调用生命周期状态机的其他回调来管理注销过程。这通常包括调用`on_deactivate()`函数，该函数将节点从活跃状态转换为非活跃状态，从而停止节点的主要功能。在这个状态，节点不再处理新的数据或请求。

随后，节点将取消注册所有的处理函数，或称为回调函数（handlers）。这包括从执行器中注销与定时器相关的`time_up()`回调，注销服务服务器和客户端的`request_receive()`和`results_receive()`回调，以及注销主题订阅者的`topic_receive()`回调。取消注册回调函数是一个重要的步骤，它通知执行器不再调度这些函数，因为节点即将关闭。

最后，执行生命周期状态机的`on_cleanup()`回调函数，以便进行资源清理。这个函数负责释放节点在活跃期间使用的资源，如关闭打开的文件、断开网络连接、释放内存等。这一步骤至关重要，确保了节点的有序和干净的关闭，防止资源泄漏和未决操作。

关闭过程完成后，节点及其相关资源被适当地释放和注销，执行器将不再处理来自该节点的任何事件。这个过程保证了在ROS 2系统中节点的生命周期得到妥善管理，确保了系统资源的有效利用和稳定性。