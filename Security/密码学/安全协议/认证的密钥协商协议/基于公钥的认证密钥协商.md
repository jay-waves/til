通信密钥分为长期密钥 (主密钥) 和短期密钥 (会话密钥), 应为每一次会话生成短期会话密钥, 保证两者的独立性. 同时, 会话密钥应有前向保密性.

成功的密钥交换需要满足下列条件:
- 只有通信双方知道 K
- 通信双方确保对方知道 K
- 通信双方知道 K 是新生成的.

基于公钥密码进行密钥交换, 核心问题是**信任性**问题. 即如何对彼此的身份进行认证, 防范[中间人攻击](../../公钥密码/密钥协商/DiffieHellman.md). 现有解决方案是基于 [PKI](../密钥分发与管理.md) 系统, 使用证书信任链验证彼此身份. 虽然基于证书链也要一定程度依赖于可信第三方的参与, 但"基于公钥的密钥协商"并不像["基于单钥的密钥协商"](基于单钥的认证密钥协商.md)那样要求第三方实时在线.

## 基于 DH 构造

指基于各类有限域上 [DiffieHellman](../../公钥密码/密钥协商/DiffieHellman.md) 问题构造的密钥交换方法. 双方各持有私钥 $k_{1},k_{2}$, 交换公钥 $g^{k_{1}},g^{k_{2}}$, 从而构造秘密值 $g^{k_{1}k_{2}}$. 

DH 构造的优点是, 私钥 $k$ 可临时生成, 用完即弃. 保证了前向保密性.

### 端到端协议

使用数字签名(证书验证)的方式, 保证消息来源的真实性:

![|500](../../../../attach/Pasted%20image%2020231015134438.png)

其中, $Cert=(ID,\ Ver,\ Sig(ID,\ Ver))$. Ver 和 Sig 为算法.

<br>

**不安全的端到端协议变形:**

![|450](/attach/错误的端到端协议.png)

如果攻击者知晓了 Bob 的某个私钥, 它就可以冒充 Bob 与 Alice 建立密钥, 因为 Alice 没有对 Bob 进行挑战应答. 
泄露私钥的方式有很多, 比如之前的临时密钥未按规定销毁; 或者, 没有层次化密钥保护, 同一组公私钥用于多类功能, 导致攻击者可以欺骗 Bob 给自己构造的密钥签名.

### MTI 协议

见 [MTI](../../公钥密码/密钥协商/MTI.md)

引入证书验证, 但是无需签名. 仅需两次消息传递.

### ECMQV 协议

见 
[ECMQV 协议](../../公钥密码/ECC/ECMQV.md)

## 基于一般公钥加密

如基于 RSA, ElGamal 等协议对临时密钥进行加密保护. 缺点是**没有前向保密性**, 由于私钥被长期持有使用, 一旦泄露, 之前所有的密钥交换信息都会泄露. 因此, TLSv1.3 将基于 RSA 的密钥交换剔除, 仅保留基于 DH 构造的各类密钥交换.

除了使用 DH 构造, 前向保密性问题还可以通过[密钥层次化](../密钥分发与管理.md)来解决. 

### NSPK 协议

![|500](../../../../attach/Pasted%20image%2020231015160719.png)

前三步是标准的认证操作. 最后一步将共享密钥 [先签名再加密](../../公钥密码/RSA/RSA%20签名.md), 但如果 $K_{s}$ 泄露, 不重置会话就无法抵抗重放攻击.

#### 平行会话攻击

NKPK 协议原始版本存在平行会话攻击漏洞, 在 1995 年被 Gavin Lowe 发现, 也称为 Lowe 攻击.

| 步骤 | 流向   | 内容                               | 流向   | 内容                                    |
| ---- | ------ | ---------------------------------- | ------ | --------------------------------------- |
| 1    | $A\to E$ | $\large\{ N_{1},A\}_{PK(E)}$       |        |                                         |
| 2    |        |                                    | ${} E\to B {}$ | $\large\{ N_{1},A \}_{PK(B)}$     |
| 3    |        |                                    | ${} E\leftarrow B {}$| $\large\{ N_{1},N_{2} \}_{PK(A)}$ |
| 4    | ${} A\leftarrow E {}$ | $\large \{ N_{1},N_{2} \}_{PK(A)}$ |        |                                         |
| 5    | $A\to E$ | $\large \{ N_{2} \}_{P(E)}$  |           |
| 6     |        |                                    | $E\to B$ |   $\large \{ N_{2} \}_{PK(B)}$                                      |

结果: 
- A 认为自己正与 B 通信
- B 认为自己正与 E 通信
- E 可以解密和操控双方的会话内容.

问题在于: AB 通信双方的身份没有明确绑定到消息交换和随机数上, 导致利用重放可以完成攻击. 

Lowe 对协议做了如下改进: 第二步绑定身份信息
1. $A\to B$: $\{ N_{1},A \}_{PK(B)}$
2. $B\to A$: $\{N_{1},N_{2},B\}_{PK(A)}$
3. $A\to B$: $\{ N_{2} \}_{PK(B)}$

