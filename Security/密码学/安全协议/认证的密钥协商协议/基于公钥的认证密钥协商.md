密钥分为长期密钥(主密钥)和短期密钥(会话密钥), 应为每一次会话生成短期会话密钥, 保证两者的独立性. 同时, 会话密钥应有前向保密性.

成功的密钥交换需要满足下列条件:
- 只有通信双方知道 K
- 通信双方确保对方知道 K
- 通信双方知道 K 是新生成的.

## Diffie Hellman 协议

见 [DiffieHellman](../../公钥密码/密钥协商/DiffieHellman.md)

DH 协议易遭受**中间人攻击**. 

## 端到端协议

使用数字签名(证书验证)的方式, 保证消息来源的真实性:

![|500](../../../../attach/Pasted%20image%2020231015134438.png)

其中, $Cert=(ID,\ Ver,\ Sig(ID,\ Ver))$. Ver 和 Sig 为算法.

<br>

**不安全的端到端协议变形:**

![|450](/attach/错误的端到端协议.png)

如果攻击者知晓了 Bob 的某个私钥, 它就可以冒充 Bob 与 Alice 建立密钥, 因为 Alice 没有对 Bob 进行挑战应答. 
泄露私钥的方式有很多, 比如之前的临时密钥未按规定销毁; 或者, 没有层次化密钥保护, 同一组公私钥用于多类功能, 导致攻击者可以欺骗 Bob 给自己构造的密钥签名.

## NSPK 协议

![|500](../../../../attach/Pasted%20image%2020231015160719.png)

前三步是标准的认证操作. 最后一步将共享密钥 [先签名再加密](../../公钥密码/RSA/RSA-签名.md), 但如果 $K_{s}$ 泄露, 不重置会话就无法抵抗重放攻击.

### 平行会话攻击

NKPK 协议原始版本存在平行会话攻击漏洞, 在 1995 年被 Gavin Lowe 发现, 也称为 Lowe 攻击.

| 步骤 | 流向   | 内容                               | 流向   | 内容                                    |
| ---- | ------ | ---------------------------------- | ------ | --------------------------------------- |
| 1    | ${} A\to E {}$ | $\large\{ N_{1},A\}_{PK(E)}$       |        |                                         |
| 2    |        |                                    | ${} E\to B {}$ | $\large\{ N_{1},A \}_{PK(B)}$     |
| 3    |        |                                    | ${} E\leftarrow B {}$| $\large\{ N_{1},N_{2} \}_{PK(A)}$ |
| 4    | ${} A\leftarrow E {}$ | $\large \{ N_{1},N_{2} \}_{PK(A)}$ |        |                                         |
| 5    | $A\to E$ | $\large \{ N_{2} \}_{P(E)}$  |           |
| 6     |        |                                    | $E\to B$ |   $\large \{ N_{2} \}_{PK(B)}$                                      |

结果: 
- A 认为自己正与 B 通信
- B 认为自己正与 E 通信
- E 可以解密和操控双方的会话内容.

问题在于: AB 通信双方的身份没有明确绑定到消息交换和随机数上, 导致利用重放可以完成攻击. 

Lowe 对协议做了如下改进: 第二步绑定身份信息
1. $A\to B$: ${} \{ N_{1},A \}_{PK(B)} {}$
2. $B\to A$: ${} \{N_{1},N_{2},B\}_{PK(A)} {}$
3. $A\to B$: $\{ N_{2} \}_{PK(B)}$

## MTI 协议

见 [MTI](../../公钥密码/密钥协商/MTI.md)

引入证书验证, 但是无需签名. 仅需两次消息传递.


## ECMQV 协议

见 
[ECMQV 协议](../../公钥密码/ECC/ECMQV.md)