---
revised: 24-11-29
code:
  - src/cryptography/ec_plot.py
---

## 1 实数域椭圆曲线运算

满足 Weierstrass 方程的点集, 称为椭圆曲线 (Elliptic Curve): $$Y^{2}=X^{3}+aX+b$$

也记为 $EC(a,b)$, 其中 $4a^{3}+37b^{2}\not=0$. 该条件保证了曲线是非奇异的, 意味着曲线几何上无不可导尖锐点/自相交点/孤立点, 有利于下面定义更完备的运算性质.

| $y^{2}=x^{3}-3x+3$                 | $y^{2}=x^{3}-6x+5$                  |
| ---------------------------------- | ----------------------------------- |
| ![](/attach/curve_-3_3.avif)        | ![](../../../attach/curve_-6_5.avif) |
| $y^{2}=x^{3}$ 含不可导点           | $y^{2}=x^{3}-3x+2$ 含自相交点                 |
| ![](../../../attach/curve_0_0.avif) | ![](../../../attach/curve_-3_2.avif)                                    |

### 1.1 负元

点 $\mathbf{P}:(x,y)$ 的负元是其关于 x 轴的对称点 $(x,-y)$.

### 1.2 点加法

**定义**  
$P(x_{1},y_{1})$, $Q(x_{2},y_{2})$ 和 $R(x_{3},y_{3})$ , 若 $P+Q = R$, 则三点有如下关系:

$x_3≡k^2-x_1-x_2$  
$y_3≡k(x_{3}-x_{1})+y_{1}$

其中, 斜率 k 计算方式如:

$$k=\left\{
\begin{align}
\frac{3x_{1}+a}{2y_{1}},\ if\ P=\ Q\hspace{100cm}\\
\frac{y_2-y_1}{x_2-x_{1}},\ if\ P\neq\ Q\hspace{100cm}
\end{align}\right.$$

几何上, R 是 PQ 直线与曲线交点的关于 x 轴的对称点.  

#### $P\neq Q$ 推导

![|300](../../../attach/密码学_ECC加法.avif)

- **先求直线 PQR**

设 $P(x_{1}, y_{1})$, $Q(x_{2}, y_{2})$

斜率 $k$: $$k=\frac{y_{2}-y_{1}}{x_{2}-x_{1}}$$

所以直线表示为: $y=k*x+t$

- **计算直线 PQR 与椭圆曲线的交点**

得 $$(k*x+t)^2=x^3+a*x+b$$, 展开为 $$x^3-k^2*x^2+(a-2kt)*x+b-t^2=0$$

已知实数域上上述三次方程必有解, 由代数基本定理知, 上述方程等价为: $$(x-x_{1})(x-x_{2})(x-x_{3})=0$$

两者比较[^1]得 $$-(x_{1}+x_{2}+x_{3})*x^2=-k^{2}*x^2$$, 即 $x_{1}+x_{2}+x_{3}=k^2$

[^1]: 也称为[韦达定理](https://en.wikipedia.org/wiki/Vieta%27s_formulas).

要求 $y_{3}$, 使用斜率公式即可: $k=\frac{y_{3}-y_{1}}{x_{3}-x_{1}}$

#### $P=Q$ 推导

![|300](../../../attach/密码学_ECC倍乘.avif)

依点加法几何含义, 此时直线 RPQ 为 P 点的切线, 求此时斜率:  

同时对 $x$ 求导: $$2*y*y'=3*x^{2}+a$$  

得斜率: $$k=y'=\frac{3*x^{2}+a}{2*y}$$

其余公式和 $P\neq Q$ 情景相同

#### 无穷远点

以上加法不完备(满足封闭性), 存在两点 x 坐标相同时, 不存在第三个点的情况. 

因此定义无穷远为"无穷远点", 记为 $\mathcal{O}$, 有 $P=\mathcal{O}+P$

由于当 $b\neq{0}$ 时, $y^2=x^3+ax+b$ 形式的曲线不过 $(0, 0)$ 点, 故程序中通常记 $\mathcal{O}=(0, 0)$

### 1.3 点数乘

对于正整数 $n$ 和椭圆曲线上点 $P$, **定义**数乘运算: $[n]P=P+P+P+\dots+P$

蒙哥马利算法, 类似[快速模幂算法](../../数论/快速模幂算法.md). 计算 $[n]P$ 时, 复杂度约为 ${} \mathcal{O}(M(n)\cdot\log n) {}$, $M(n)$ 是单次自加的复杂度.

```
R0 = P
R1 = 2 * P
if k_i == 0:
	R1 = R0 + R1
	R0 = 2 * R0
if # k_i == 1:
	R0 = R0 + R1
	R1 = 2 * R1
```

<br>

## 素域上的椭圆曲线

密码学更关心离散的问题, 因此密码学将椭圆曲线定义到有限域上:
1. 素域 $GF(p)$, 也同构于 $\mathbb{Z}_{p}$. 
2. 扩域 $GF(p^{n})$, 元素为多项式, 更适合硬件算法.

密码学椭圆曲线仍定义为 (为啥捏...): $$Y^{2}=X^{3}+aX+b$$, 其中 $X,Y$ 为有限域上的元素, $+$ 和 $\cdot$ 是有限域上的运算, 数乘和幂运算分别是加法和乘法的衍生运算.

### 2 点集群

椭圆曲线在有限域 $\mathbb{Z}_{p}$ 上的点集, 构成一个Abel交换群:

**证明**  
- 封闭性: 由"1.2 点加法"中的论述显然
- 有单位元: $\mathbf{P}+\mathcal{O}=\mathcal{O}+\mathbf{P}=\mathbf{P}$
- 有逆元: $\mathbf{P}+(\mathbf{-P})=\mathcal{O}$. 其中 $-\mathbf{P}$ 是 $\mathbf{P}$ 关于 x 轴的对称点.
- 结合律: $\mathbf{(P+Q)+R}=\mathbf{P+(Q+R)}$
- 交换律: $\mathbf{P+Q}=\mathbf{Q+P}$

#### 2.1 点集群的阶

**该点集群的阶即素域 $\mathbb{Z}_{p}$ 上的椭圆曲线的点个数**. 由于 $x$ 的整数性不保证 $y$ 的整数性, 所以并非素域上所有 $x$ 值都能由垂直 $x$ 轴直线映射到一个椭圆曲线上的点 $(x,y)$, 其中 $x,y\in \mathbb{Z}_{p}$. 因此椭圆曲线上的群的阶不一定是 $p$.

为了验证素域上元素满足映射: $\varphi: x\to \left(x,\sqrt{ x^{3}+ax+b }\right)$, 需要遍历素域, 然后验证 $x^{3}+ax+b$ 是否是模 $p$ 的二次剩余, 即是否存在一个整数 $y$ 满足 $y^{2}=x^{3}+ax+b\pmod p$. 

由哈瑙尔定理知, 素域上的椭圆曲线点集群的阶满足: $$|E(\mathbb{Z}_{p})|=p+1-t$$, 其中 $t$ 是和曲线迹相关的整数, 满足 $|t|\leq 2\sqrt{ p }$. 说明其最小为 ${} |E(\mathbb{Z}_{p})|=(\sqrt{ p }-1)^{2} {}$

当点总数 $|E(\mathbb{Z}_{p})|$ 是素数时, 该群就是一个循环群. 否则则是多个循环群的直积, 显然密码学对前者更感兴趣. 

#### 子群的阶与基点G

ECC 选择 G 时, 需选一个阶比较大的点, 以保证有足够的私钥 $d$

> 见 [ECC](../../../Security/密码学/公钥密码/ECC/ECC.md)

> 子群阶 to be continue...

#### 2.2 ECDLP

椭圆曲线上的[离散对数问题](../../../数论/欧拉定理.md) (ECDLP, Elliptic Curve Discrete Logarithem Problem), 定义为: **给出点 $\mathbf{P}$ 和数乘 $n\mathbf{P}$, 求出 $n$ 是困难的**. 目前最快的 ECDLP 算法, 也需要 $\mathbf{O}(\sqrt{ p })$ 求解.

## 参考

注意, 图片可能包含未知版权信息.
- [有限域上的椭圆曲线 by Ruan Xingzhi](https://www.ruanx.net/elliptic-curve/)
- <https://zh.wikipedia.org/wiki/椭圆曲线>
- <https://en.wikipedia.org/wiki/Elliptic_curve_point_multiplication>
